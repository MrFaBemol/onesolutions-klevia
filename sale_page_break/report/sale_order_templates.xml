<odoo>
  <template id="report_saleorder_document" inherit_id="sale.report_saleorder_document">
    <xpath expr="//table[contains(@class, 'o_main_table')]" position="replace">
      <t t-set="g_index" t-value="0"/>
      <t t-foreach="doc.group_lines_for_page_break()" t-as="group">
        <t t-if="g_index > 0">
          <div style="page-break-before: always; height: 1px;"></div>
        </t>

        <table class="o_has_total_table table o_main_table table-borderless">
          <thead style="display: table-row-group">
            <tr>
              <th class="text-start">Description</th>
              <th class="text-end text-nowrap">Quantity</th>
              <th class="text-end text-nowrap"></th>
              <th class="text-end text-nowrap">Unit Price</th>
              <th t-if="display_discount" class="text-end"><span>Disc.%</span></th>
              <th class="text-end">Taxes</th>
              <th class="text-end"><span>Amount</span></th>
            </tr>
          </thead>

          <tbody class="sale_tbody">
            <t t-set="current_subtotal" t-value="0"/>
            <t t-set="current_section" t-value="None"/>

            <t t-foreach="group" t-as="line" t-index="line_index">
              <t t-if="line">
                <!-- Subtotal before new section -->
                <t t-if="line.display_type == 'line_section' and current_section">
                  <tr class="is-subtotal text-end">
                    <td colspan="99">
                      <strong class="mr16">Subtotal</strong>
                      <span t-out="current_subtotal"
                            t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                    </td>
                  </tr>
                  <t t-set="current_subtotal" t-value="0"/>
                </t>

                <t t-set="line_class" t-value="
                  'fw-bold o_line_section' if line.display_type == 'line_section'
                  else 'fst-italic o_line_note' if line.display_type == 'line_note'
                  else ''"/>
                <tr t-att-class="line_class">

                  <t t-if="not line.display_type">
                    <t t-set="current_subtotal" t-value="current_subtotal + (line.price_subtotal or 0)"/>
                    <td><span t-field="line.name"/></td>
                    <td class="text-end"><span t-field="line.product_uom_qty"/></td>
                    <td class="text-end"><span t-field="line.product_uom"/></td>
                    <td class="text-end"><span t-field="line.price_unit"/></td>
                    <td t-if="display_discount" class="text-end"><span t-field="line.discount"/></td>
                    <td class="text-end">
                      <span t-out="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_id])"/>
                    </td>
                    <td class="text-end"><span t-field="line.price_subtotal"/></td>
                  </t>

                  <t t-elif="line.display_type == 'line_section'">
                    <td colspan="99"><span t-field="line.name"/></td>
                    <t t-set="current_section" t-value="line.name"/>
                  </t>

                  <t t-elif="line.display_type == 'line_note'">
                    <td colspan="99"><span t-field="line.name"/></td>
                  </t>
                </tr>

                <!-- Subtotal at end of group -->
                <t t-if="line_index + 1 == len(group)">
                  <tr class="is-subtotal text-end" t-if="current_section">
                    <td colspan="99">
                      <strong class="mr16">Subtotal</strong>
                      <span t-out="current_subtotal"
                            t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                    </td>
                  </tr>
                </t>

              </t>
            </t>
          </tbody>
        </table>

        <t t-set="g_index" t-value="g_index + 1"/>
      </t>
    </xpath>
  </template>
</odoo>
